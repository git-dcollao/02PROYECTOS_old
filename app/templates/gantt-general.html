{% extends 'base_layout.html' %}

{% block title %}Vista Gantt - Proyectos{% endblock %}

{% block head %}
    {{ super() }}
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">
    
    <style>
        .progress-bar-custom {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            position: relative;
            overflow: hidden;
        }
        .progress-fill-custom {
            height: 100%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .estado-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
        }
        .btn-sm-custom {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 1px;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }
        .proyecto-title {
            color: #495057;
            font-weight: 500;
        }
        .fecha-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">üìä Vista Gantt - Proyectos</h2>
                    <p class="text-muted mb-0">Visi√≥n general de cronogramas y progreso de proyectos</p>
                </div>
                <div>
                    <span class="badge bg-info fs-6">{{ proyectos_data|length }} Proyectos</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Proyectos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üóìÔ∏è Cronograma de Proyectos</h5>
                </div>
                <div class="card-body">
                    {% if proyectos_data %}
                    <div class="table-responsive">
                        <table id="tablaProyectos" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Proyecto</th>
                                    <th>Estado</th>
                                    <th>Actividades</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Progreso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for proyecto in proyectos_data %}
                                <tr>
                                    <td>
                                        <div class="proyecto-title">
                                            <strong>{{ proyecto.requerimiento.titulo }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                ID: {{ proyecto.requerimiento.id }} | 
                                                {{ proyecto.requerimiento.grupo_obj.nombre if proyecto.requerimiento.grupo_obj else 'Sin grupo' }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if proyecto.requerimiento.estado_obj %}
                                            <span class="badge estado-badge
                                                {% if proyecto.requerimiento.estado_obj.id == 1 %}bg-secondary{% endif %}
                                                {% if proyecto.requerimiento.estado_obj.id == 2 %}bg-warning text-dark{% endif %}
                                                {% if proyecto.requerimiento.estado_obj.id == 3 %}bg-info{% endif %}
                                                {% if proyecto.requerimiento.estado_obj.id == 4 %}bg-success{% endif %}
                                                {% if proyecto.requerimiento.estado_obj.id == 5 %}bg-primary{% endif %}
                                            ">
                                                {{ proyecto.requerimiento.estado_obj.nombre }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary estado-badge">Sin estado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ proyecto.total_actividades }} actividades
                                        </span>
                                    </td>
                                    <td>
                                        {% if proyecto.fecha_inicio %}
                                            <span class="badge fecha-badge bg-success">
                                                {{ proyecto.fecha_inicio.strftime('%d/%m/%Y') }}
                                            </span>
                                        {% else %}
                                            <span class="badge fecha-badge bg-secondary">No definida</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if proyecto.fecha_fin %}
                                            <span class="badge fecha-badge bg-danger">
                                                {{ proyecto.fecha_fin.strftime('%d/%m/%Y') }}
                                            </span>
                                        {% else %}
                                            <span class="badge fecha-badge bg-secondary">No definida</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill-custom" style="width: {{ proyecto.progreso_promedio }}%">
                                                {{ "%.0f"|format(proyecto.progreso_promedio) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('controllers.ver_gantt_proyecto', requerimiento_id=proyecto.requerimiento.id) }}" 
                                           class="btn btn-outline-primary btn-sm-custom" 
                                           title="Ver Gantt Detallado">
                                            üìà Ver Gantt
                                        </a>
                                        <a href="{{ url_for('controllers.control_actividades') }}?proyecto={{ proyecto.requerimiento.id }}" 
                                           class="btn btn-outline-success btn-sm-custom" 
                                           title="Control de Actividades">
                                            ‚öôÔ∏è Control
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-chart-gantt fa-4x text-muted"></i>
                        </div>
                        <h5 class="text-muted">No hay proyectos con cronograma</h5>
                        <p class="text-muted mb-4">Los proyectos aparecer√°n aqu√≠ cuando tengan actividades asignadas</p>
                        <a href="{{ url_for('proyectos.ruta_proyecto_llenar') }}" class="btn btn-primary">
                            ‚ûï Crear Proyecto
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    $('#tablaProyectos').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[5, 'desc']], // Ordenar por progreso descendente
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
        },
        columnDefs: [
            { 
                targets: [6], // Columna de acciones
                orderable: false,
                searchable: false
            }
        ]
    });
});
</script>
{% endblock %}
