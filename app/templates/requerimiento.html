{% extends 'bases/base.html' %}

{% block title %}Ingreso de Requerimientos {% endblock %}

{% block content %}
<div class="container">
  <div class="well text-center">
      <h1>Ingreso de Requerimientos</h1>
  </div>

  <div class="container">
    <div class="row">
        <div class="col md-12">
          <h2>
            Lista de requeriminetos solicitados
            <button class="btn btn-primary float-end" data-bs-target="#exampleModal" data-bs-toggle="modal"
                    type="button">
              Nuevo Requerimiento
            </button>
          </h2>

          <table class="table table-striped">
            <thead>
              <tr>
                <th>Id</th>
                <th>Nombre</th>
                <th>Fecha Ingreso</th>
                <th>Ver Descripción</th>
                <th>Estado</th>
                <th>Sector</th>
                <th>Tipo Recinto</th>
                <th>Recinto</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {%for requerimiento in requerimientos%}
              <tr>
                <td>{{requerimiento.id}}</td>
                <td>{{requerimiento.nombre}}</td>
                <td>{{requerimiento.fecha}}</td>
                <td>{{requerimiento.descripcion}}</td>
                <td>{{requerimiento.estado.nombre}}</td>
                <td>{{requerimiento.sector.nombre}}</td>
                <td>{{requerimiento.tiporecinto.nombre}}</td>
                <td>{{requerimiento.recinto.nombre}}</td>
                <td>
                  <a class="btn p-1 btn-primary btn-sm" 
                     data-bs-target="#exampleModal1{{requerimiento.id}}"
                     data-bs-toggle="modal"
                     href="#">Editar</a> 
                  <form action="{{ url_for('controllers.eliminar_requerimiento', id=requerimiento.id) }}"
                      method="POST" style="display:inline;">
                      <button class="btn p-1 btn-danger btn-sm" 
                      type="submit">Eliminar</button>
                  </form>
                </td>
                <div aria-hidden="true" aria-labelledby="exampleModalLabel1" class="modal fade"
                   id="exampleModal1{{requerimiento.id}}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel1">Editar información del requerimiento {{requerimiento.nombre}}</h1>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                      </div>
                      <div class="modal-body">
                        <form action="{{ url_for('controllers.update_requerimiento', id=requerimiento.id) }}" method="POST">   
                          <div class="form-group">
                            <label>Nombre:</label>
                            <input type="hidden" name="id" value="{{requerimiento.id}}">
                            <input class="form-control" name="nombre" value="{{requerimiento.nombre}}" required="1" type="text">
                            <label>Fecha:</label>
                            <input class="form-control" name="fecha" value="{{requerimiento.fecha}}" id="fecha" required="1" type="text" placeholder="Seleccione fecha">
                            <div class="form-group"></div>
                            <label>Descripción:</label>
                            <input class="form-control" name="descripcion" value="{{requerimiento.descripcion}}" required="1" type="text">
                            <label>sector:</label>
                            <select class="form-control sector-select" name="id_sector" id="sector-select{{requerimiento.id}}" required="1">
                              <option value="">Seleccione un Sector</option>
                              {% for sector in sectores %}
                              <option value="{{ sector.id }}" {% if sector.id == requerimiento.id_sector %}selected{% endif %}>
                                {{ sector.nombre }}
                              </option>
                              {% endfor %}
                            </select>

                            <label>Tipo de Recinto:</label>
                            <select class="form-control tiporecinto-select" name="id_tiporecinto" 
                                    id="tiporecinto-select{{requerimiento.id}}" required="1"
                                    data-current="{{requerimiento.id_tiporecinto}}">
                              <option value="">Seleccione un Tipo de Recinto</option>
                              {% if requerimiento.tiporecinto %}
                              <option value="{{ requerimiento.tiporecinto.id }}" selected>
                                {{ requerimiento.tiporecinto.nombre }}
                              </option>
                              {% endif %}
                            </select>

                            <label>Recinto:</label>
                            <select class="form-control recinto-select" name="id_recinto" 
                                    id="recinto-select{{requerimiento.id}}" required="1"
                                    data-current="{{requerimiento.id_recinto}}">
                              <option value="">Seleccione un Recinto</option>
                              {% if requerimiento.recinto %}
                              <option value="{{ requerimiento.recinto.id }}" selected>
                                {{ requerimiento.recinto.nombre }}
                              </option>
                              {% endif %}
                            </select>
                          </div>
                          <button type="submit" class="btn btn-primary">Actualizar</button>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button class="btn btn-danger" data-bs-dismiss="modal" type="button">
                          Cerrar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </tr>
              {%endfor%}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal para agregar nuevo estado -->
    <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="exampleModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar Requerimiento</h1>
            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
          </div>
          <div class="modal-body">
            <form action="{{ url_for('controllers.add_requerimiento') }}" method="POST"> 
              <div class="form-group">
                <label>Nombre:</label>
                <input class="form-control" name="nombre" required="1" type="text">
                
                  <label>Fecha:</label>
                  <input class="form-control" name="fecha" id="fecha" required="1" type="text" placeholder="Seleccione fecha">
                <div class="form-group"></div>
                <label>Descripción:</label>
                <input class="form-control" name="descripcion" required="1" type="text">
                <label>sector:</label>
                <select class="form-control sector-select" name="id_sector" id="sector-select" required="1">
                  <option value="">Seleccione un Sector</option>
                  {% for sector in sectores %}
                  <option value="{{ sector.id }}">{{ sector.nombre }}</option>
                  {% endfor %}
                </select>

                <label>Tipo de Recinto:</label>
                <select class="form-control tiporecinto-select" name="id_tiporecinto" id="tiporecinto-select" required="1" disabled>
                  <option value="">Primero seleccione un sector</option>
                </select>                        

                <label>Recinto:</label>
                <select class="form-control recinto-select" name="id_recinto" id="recinto-select" required="1" disabled>
                  <option value="">Primero seleccione un tipo de recinto</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Agregar</button>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-danger" data-bs-dismiss="modal" type="button">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
<div class="well container">
  
</div>

<!-- Agregar en el head del template o antes de cerrar </body> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<!-- Agregar al final del archivo -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Si necesitas alguna funcionalidad JavaScript adicional para el combo
    const sectorSelect = document.querySelector('select[name="id_sector"]');
    
    sectorSelect.addEventListener('change', function() {
        const selectedSector = this.value;
        console.log('Sector seleccionado:', selectedSector);
    });
  });
</script>
  
<script>
  // Initialize the date picker
  flatpickr("#fecha", {
    dateFormat: "d/m/Y",
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuración del calendario
    flatpickr("#fecha", {
      locale: "es",
      dateFormat: "Y-m-d",
      defaultDate: new Date(),
      altInput: true,
      altFormat: "d/m/Y",
    });
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sectorSelect = document.getElementById('sector-select');
    const tipoRecintoSelect = document.getElementById('tiporecinto-select');
    const recintoSelect = document.getElementById('recinto-select');

    sectorSelect.addEventListener('change', function() {
        const sectorId = this.value;
        if (sectorId) {
            tipoRecintoSelect.disabled = false;
            
            fetch(`/get_tiposrecintos_by_sector/${sectorId}`)
                .then(response => response.json())
                .then(data => {
                    tipoRecintoSelect.innerHTML = '<option value="">Seleccione un Tipo de Recinto</option>';
                    data.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nombre;
                        tipoRecintoSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
                
            // Resetear y deshabilitar el select de recintos
            recintoSelect.disabled = true;
            recintoSelect.innerHTML = '<option value="">Primero seleccione un tipo de recinto</option>';
        } else {
            tipoRecintoSelect.disabled = true;
            tipoRecintoSelect.innerHTML = '<option value="">Primero seleccione un sector</option>';
            recintoSelect.disabled = true;
            recintoSelect.innerHTML = '<option value="">Primero seleccione un tipo de recinto</option>';
        }
    });

    tipoRecintoSelect.addEventListener('change', function() {
        const tipoRecintoId = this.value;
        if (tipoRecintoId) {
            recintoSelect.disabled = false;
            
            fetch(`/get_recintos_by_tipo/${tipoRecintoId}`) 
                .then(response => response.json())
                .then(data => {
                    recintoSelect.innerHTML = '<option value="">Seleccione un Recinto</option>';
                    data.forEach(recinto => {
                        const option = document.createElement('option');
                        option.value = recinto.id;
                        option.textContent = recinto.nombre;
                        recintoSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        } else {
            recintoSelect.disabled = true;
            recintoSelect.innerHTML = '<option value="">Primero seleccione un tipo de recinto</option>';
        }
    });
});
</script>


<script>
function initializeSelects(formElement) {
    const sectorSelect = formElement.querySelector('.sector-select');
    const tipoRecintoSelect = formElement.querySelector('.tiporecinto-select');
    const recintoSelect = formElement.querySelector('.recinto-select');

    if (!sectorSelect || !tipoRecintoSelect || !recintoSelect) return;

    // Mantener valores actuales al editar
    const currentTipoRecinto = tipoRecintoSelect.getAttribute('data-current');
    const currentRecinto = recintoSelect.getAttribute('data-current');

    sectorSelect.addEventListener('change', async function() {
        // ... código existente
    });

    // Si hay sector seleccionado, cargar tipos de recinto inicialmente
    if (sectorSelect.value) {
        sectorSelect.dispatchEvent(new Event('change'));
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Para cada modal de edición
    document.querySelectorAll('[id^="exampleModal1"]').forEach(modal => {
        const sectorSelect = modal.querySelector('.sector-select');
        const tipoRecintoSelect = modal.querySelector('.tiporecinto-select');
        const recintoSelect = modal.querySelector('.recinto-select');

        if (sectorSelect && tipoRecintoSelect && recintoSelect) {
            // Habilitar los selects
            tipoRecintoSelect.disabled = false;
            recintoSelect.disabled = false;

            // Configurar el evento change del sector
            sectorSelect.addEventListener('change', function() {
                const sectorId = this.value;
                if (sectorId) {
                    tipoRecintoSelect.disabled = false;
                    fetch(`/get_tiposrecintos_by_sector/${sectorId}`)
                        .then(response => response.json())
                        .then(data => {
                            const currentTipoRecinto = tipoRecintoSelect.getAttribute('data-current');
                            tipoRecintoSelect.innerHTML = '<option value="">Seleccione un Tipo de Recinto</option>';
                            data.forEach(tipo => {
                                const option = document.createElement('option');
                                option.value = tipo.id;
                                option.textContent = tipo.nombre;
                                if (tipo.id == currentTipoRecinto) {
                                    option.selected = true;
                                }
                                tipoRecintoSelect.appendChild(option);
                            });
                            // Disparar el evento change en tipoRecintoSelect si hay un valor seleccionado
                            if (currentTipoRecinto) {
                                tipoRecintoSelect.dispatchEvent(new Event('change'));
                            }
                        });
                }
            });

            // Configurar el evento change del tipo de recinto
            tipoRecintoSelect.addEventListener('change', function() {
                const tipoRecintoId = this.value;
                if (tipoRecintoId) {
                    recintoSelect.disabled = false;
                    fetch(`/get_recintos_by_tipo/${tipoRecintoId}`)
                        .then(response => response.json())
                        .then(data => {
                            const currentRecinto = recintoSelect.getAttribute('data-current');
                            recintoSelect.innerHTML = '<option value="">Seleccione un Recinto</option>';
                            data.forEach(recinto => {
                                const option = document.createElement('option');
                                option.value = recinto.id;
                                option.textContent = recinto.nombre;
                                if (recinto.id == currentRecinto) {
                                    option.selected = true;
                                }
                                recintoSelect.appendChild(option);
                            });
                        });
                }
            });

            // Disparar el evento change inicial para cargar los datos
            if (sectorSelect.value) {
                sectorSelect.dispatchEvent(new Event('change'));
            }
        }
    });
});
</script>
{% endblock %}